--- a/net/minecraft/server/level/ServerEntity.java
+++ b/net/minecraft/server/level/ServerEntity.java
@@ -6,6 +_,7 @@
 import java.util.ArrayList;
 import java.util.Collection;
 import java.util.Collections;
+import java.util.HashSet;
 import java.util.List;
 import java.util.Set;
 import java.util.function.Consumer;
@@ -28,6 +_,7 @@
 import net.minecraft.network.protocol.game.ClientboundUpdateAttributesPacket;
 import net.minecraft.network.protocol.game.VecDeltaCodec;
 import net.minecraft.network.syncher.SynchedEntityData;
+import net.minecraft.server.network.ServerPlayerConnection;
 import net.minecraft.util.Mth;
 import net.minecraft.world.entity.Entity;
 import net.minecraft.world.entity.EquipmentSlot;
@@ -62,13 +_,26 @@
     private Vec3 lastSentMovement;
     private int tickCount;
     private int teleportDelay;
-    private List<Entity> lastPassengers = Collections.emptyList();
+    private List<Entity> lastPassengers = com.google.common.collect.ImmutableList.of(); // Paper - optimize passenger checks
     private boolean wasRiding;
     private boolean wasOnGround;
     @Nullable
     private List<SynchedEntityData.DataValue<?>> trackedDataValues;
+    // CraftBukkit start
+    public Set<ServerPlayerConnection> trackedPlayers = new HashSet<>();
+
+    public ServerEntity seenBy(Set<ServerPlayerConnection> trackedPlayers) {
+        this.trackedPlayers = trackedPlayers;
+        return this;
+    }
+
+    public ServerEntity(ServerLevel p_8528_, Entity p_8529_, int p_8530_, boolean p_8531_, Consumer<Packet<?>> p_8532_, Set<ServerPlayerConnection> trackedPlayers) {
+        this(p_8528_, p_8529_, p_8530_, p_8531_, p_8532_);
+        this.trackedPlayers = trackedPlayers;
+    }
 
     public ServerEntity(ServerLevel p_8528_, Entity p_8529_, int p_8530_, boolean p_8531_, Consumer<Packet<?>> p_8532_) {
+        // CraftBukkit end
         this.level = p_8528_;
         this.broadcast = p_8532_;
         this.entity = p_8529_;
@@ -86,7 +_,7 @@
     public void sendChanges() {
         List<Entity> list = this.entity.getPassengers();
         if (!list.equals(this.lastPassengers)) {
-            this.broadcast.accept(new ClientboundSetPassengersPacket(this.entity));
+            this.broadcastAndSend(new ClientboundSetPassengersPacket(this.entity)); // CraftBukkit
             removedPassengers(list, this.lastPassengers)
                 .forEach(
                     p_352697_ -> {
@@ -99,23 +_,26 @@
             this.lastPassengers = list;
         }
 
-        if (this.entity instanceof ItemFrame itemframe && this.tickCount % 10 == 0) {
-            ItemStack itemstack = itemframe.getItem();
-            if (itemstack.getItem() instanceof MapItem) {
-                MapId mapid = itemstack.get(DataComponents.MAP_ID);
-                MapItemSavedData mapitemsaveddata = MapItem.getSavedData(mapid, this.level);
-                if (mapitemsaveddata != null) {
-                    for (ServerPlayer serverplayer : this.level.players()) {
-                        mapitemsaveddata.tickCarriedBy(serverplayer, itemstack);
-                        Packet<?> packet = mapitemsaveddata.getUpdatePacket(mapid, serverplayer);
-                        if (packet != null) {
-                            serverplayer.connection.send(packet);
+        if (this.entity instanceof ItemFrame itemframe) {
+            if (true || this.tickCount % 10 == 0) { // CraftBukkit - Moved below, should always enter this block
+                ItemStack itemstack = itemframe.getItem();
+                if (this.level.paperConfig().maps.itemFrameCursorUpdateInterval > 0 && this.tickCount % this.level.paperConfig().maps.itemFrameCursorUpdateInterval == 0 && itemstack.get(DataComponents.MAP_ID) != null) { // CraftBukkit - Moved this.tickCounter % 10 logic here so item frames do not enter the other blocks
+                    MapId mapid = itemstack.get(DataComponents.MAP_ID);
+                    MapItemSavedData mapitemsaveddata = MapItem.getSavedData(itemstack, this.level);
+                    if (mapitemsaveddata != null) {
+                        for (net.minecraft.server.network.ServerPlayerConnection connection : this.trackedPlayers) { // CraftBukkit
+                            ServerPlayer serverplayer = connection.getPlayer(); // CraftBukkit
+                            mapitemsaveddata.tickCarriedBy(serverplayer, itemstack);
+                            Packet<?> packet = mapitemsaveddata.getUpdatePacket(mapid, serverplayer);
+                            if (packet != null) {
+                                serverplayer.connection.send(packet);
+                            }
                         }
                     }
                 }
-            }
 
-            this.sendDirtyEntityData();
+                this.sendDirtyEntityData();
+            }
         }
 
         if (this.tickCount % this.updateInterval == 0 || this.entity.hasImpulse || this.entity.getEntityData().isDirty()) {
@@ -221,6 +_,27 @@
 
         this.tickCount++;
         if (this.entity.hurtMarked) {
+            // CraftBukkit start - Create PlayerVelocity event
+            boolean cancelled = false;
+
+            if (this.entity instanceof ServerPlayer) {
+                org.bukkit.entity.Player player = (org.bukkit.entity.Player) this.entity.getBukkitEntity();
+                org.bukkit.util.Vector velocity = player.getVelocity();
+
+                org.bukkit.event.player.PlayerVelocityEvent event = new org.bukkit.event.player.PlayerVelocityEvent(player, velocity.clone());
+                this.entity.level().getCraftServer().getPluginManager().callEvent(event);
+
+                if (event.isCancelled()) {
+                    cancelled = true;
+                } else if (!velocity.equals(event.getVelocity())) {
+                    player.setVelocity(event.getVelocity());
+                }
+            }
+
+            if (cancelled) {
+                return;
+            }
+            // CraftBukkit end
             this.entity.hurtMarked = false;
             this.broadcastAndSend(new ClientboundSetEntityMotionPacket(this.entity));
         }
@@ -233,22 +_,28 @@
     public void removePairing(ServerPlayer p_8535_) {
         this.entity.stopSeenByPlayer(p_8535_);
         p_8535_.connection.send(new ClientboundRemoveEntitiesPacket(this.entity.getId()));
+        net.neoforged.neoforge.event.EventHooks.onStopEntityTracking(this.entity, p_8535_);
     }
 
     public void addPairing(ServerPlayer p_8542_) {
         List<Packet<? super ClientGamePacketListener>> list = new ArrayList<>();
-        this.sendPairingData(p_8542_, list::add);
+        this.sendPairingData(p_8542_, new net.neoforged.neoforge.network.bundle.PacketAndPayloadAcceptor<>(list::add));
         p_8542_.connection.send(new ClientboundBundlePacket(list));
         this.entity.startSeenByPlayer(p_8542_);
+        net.neoforged.neoforge.event.EventHooks.onStartEntityTracking(this.entity, p_8542_);
     }
 
-    public void sendPairingData(ServerPlayer p_289562_, Consumer<Packet<ClientGamePacketListener>> p_289563_) {
+    public void sendPairingData(ServerPlayer p_289562_, net.neoforged.neoforge.network.bundle.PacketAndPayloadAcceptor<net.minecraft.network.protocol.game.ClientGamePacketListener> p_289563_) {
         if (this.entity.isRemoved()) {
-            LOGGER.warn("Fetching packet for removed entity {}", this.entity);
+            // CraftBukkit start - Remove useless error spam, just return
+            // LOGGER.warn("Fetching packet for removed entity {}", this.entity);
+            return;
+            // CraftBukkit end
         }
 
         Packet<ClientGamePacketListener> packet = this.entity.getAddEntityPacket(this);
         p_289563_.accept(packet);
+        this.entity.sendPairingData(p_289562_, p_289563_::accept);
         if (this.trackedDataValues != null) {
             p_289563_.accept(new ClientboundSetEntityDataPacket(this.entity.getId(), this.trackedDataValues));
         }
@@ -256,6 +_,13 @@
         boolean flag = this.trackDelta;
         if (this.entity instanceof LivingEntity) {
             Collection<AttributeInstance> collection = ((LivingEntity)this.entity).getAttributes().getSyncableAttributes();
+
+            // CraftBukkit start - If sending own attributes send scaled health instead of current maximum health
+            if (this.entity.getId() == p_289562_.getId()) {
+                ((ServerPlayer) this.entity).getBukkitEntity().injectScaledMaxHealth(collection, false);
+            }
+            // CraftBukkit end
+
             if (!collection.isEmpty()) {
                 p_289563_.accept(new ClientboundUpdateAttributesPacket(this.entity.getId(), collection));
             }
@@ -280,8 +_,9 @@
             }
 
             if (!list.isEmpty()) {
-                p_289563_.accept(new ClientboundSetEquipmentPacket(this.entity.getId(), list));
+                p_289563_.accept(new ClientboundSetEquipmentPacket(this.entity.getId(), list, true)); // Paper - data sanitization
             }
+            ((LivingEntity) this.entity).detectEquipmentUpdatesPublic(); // CraftBukkit - SPIGOT-3789: sync again immediately after sending
         }
 
         if (!this.entity.getPassengers().isEmpty()) {
@@ -295,6 +_,7 @@
         if (this.entity instanceof Leashable leashable && leashable.isLeashed()) {
             p_289563_.accept(new ClientboundSetEntityLinkPacket(this.entity, leashable.getLeashHolder()));
         }
+        net.neoforged.neoforge.attachment.AttachmentSync.syncInitialEntityAttachments(this.entity, p_289562_, p_289563_::accept);
     }
 
     public Vec3 getPositionBase() {
@@ -327,7 +_,13 @@
 
         if (this.entity instanceof LivingEntity) {
             Set<AttributeInstance> set = ((LivingEntity)this.entity).getAttributes().getAttributesToSync();
+
             if (!set.isEmpty()) {
+                // CraftBukkit start - Send scaled max health
+                if (this.entity instanceof ServerPlayer) {
+                    ((ServerPlayer) this.entity).getBukkitEntity().injectScaledMaxHealth(set, false);
+                }
+                // CraftBukkit end
                 this.broadcastAndSend(new ClientboundUpdateAttributesPacket(this.entity.getId(), set));
             }
 
