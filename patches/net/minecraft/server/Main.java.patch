--- a/net/minecraft/server/Main.java
+++ b/net/minecraft/server/Main.java
@@ -1,6 +_,6 @@
 package net.minecraft.server;
 
-import com.mojang.authlib.yggdrasil.YggdrasilAuthenticationService;
+import com.mohistmc.youer.Youer;
 import com.mojang.datafixers.DataFixer;
 import com.mojang.logging.LogUtils;
 import com.mojang.serialization.Dynamic;
@@ -13,8 +_,9 @@
 import java.nio.file.Files;
 import java.nio.file.Path;
 import java.nio.file.Paths;
+import java.util.Arrays;
+import java.util.List;
 import java.util.Optional;
-import java.util.concurrent.Executor;
 import java.util.function.BooleanSupplier;
 import javax.annotation.Nullable;
 import joptsimple.OptionParser;
@@ -63,8 +_,16 @@
 public class Main {
     private static final Logger LOGGER = LogUtils.getLogger();
 
+    // Paper start - Reset loggers after shutdown
+    static {
+        System.setProperty("java.util.logging.manager", "io.papermc.paper.log.CustomLogManager");
+    }
+    // Paper end - Reset loggers after shutdown
+
     @DontObfuscate
-    public static void main(String[] p_129699_) {
+    public static void main(String[] p_129699_) throws Exception {
+        if (System.getProperty("jdk.nio.maxCachedBufferSize") == null) System.setProperty("jdk.nio.maxCachedBufferSize", "262144"); // Paper - cap per-thread NIO cache size; https://www.evanjones.ca/java-bytebuffer-leak.html
+        Youer.initI18n(); // Youer
         SharedConstants.tryDetectVersion();
         OptionParser optionparser = new OptionParser();
         OptionSpec<Void> optionspec = optionparser.accepts("nogui");
@@ -83,6 +_,91 @@
         OptionSpec<Void> optionspec13 = optionparser.accepts("jfrProfile");
         OptionSpec<Path> optionspec14 = optionparser.accepts("pidFile").withRequiredArg().withValuesConvertedBy(new PathConverter());
         OptionSpec<String> optionspec15 = optionparser.nonOptions();
+        optionparser.accepts("allowUpdates").withRequiredArg().ofType(Boolean.class).defaultsTo(Boolean.TRUE); // Forge: allow mod updates to proceed
+        optionparser.accepts("gameDir").withRequiredArg().ofType(File.class).defaultsTo(new File(".")); //Forge: Consume this argument, we use it in the launcher, and the client side.
+        final OptionSpec<net.minecraft.core.BlockPos> spawnPosOpt;
+        boolean gametestEnabled = Boolean.getBoolean("neoforge.gameTestServer");
+        if (gametestEnabled) {
+            spawnPosOpt = optionparser.accepts("spawnPos").withRequiredArg().withValuesConvertedBy(new net.neoforged.neoforge.gametest.BlockPosValueConverter()).defaultsTo(new net.minecraft.core.BlockPos(0, 60, 0));
+        } else {
+             spawnPosOpt = null;
+        }
+
+        optionparser.acceptsAll(Arrays.asList("b", "bukkit-settings"), "File for bukkit settings")
+                .withRequiredArg()
+                .ofType(File.class)
+                .defaultsTo(new File("bukkit.yml"))
+                .describedAs("Yml file");
+
+        optionparser.acceptsAll(Arrays.asList("C", "commands-settings"), "File for command settings")
+                .withRequiredArg()
+                .ofType(File.class)
+                .defaultsTo(new File("commands.yml"))
+                .describedAs("Yml file");
+
+        optionparser.acceptsAll(Arrays.asList("P", "plugins"), "Plugin directory to use")
+                .withRequiredArg()
+                .ofType(File.class)
+                .defaultsTo(new File("plugins"))
+                .describedAs("Plugin directory");
+
+        optionparser.acceptsAll(List.of("nojline"), "Disables jline and emulates the vanilla console");
+        optionparser.acceptsAll(List.of("noconsole"), "Disables the console");
+
+        // Spigot Start
+        optionparser.acceptsAll(Arrays.asList("S", "spigot-settings"), "File for spigot settings")
+                .withRequiredArg()
+                .ofType(File.class)
+                .defaultsTo(new File("spigot.yml"))
+                .describedAs("Yml file");
+        // Spigot End
+        // Paper start
+        optionparser.acceptsAll(Arrays.asList("paper-dir", "paper-settings-directory"), "Directory for Paper settings")
+                .withRequiredArg()
+                .ofType(File.class)
+                .defaultsTo(new File(io.papermc.paper.configuration.PaperConfigurations.CONFIG_DIR))
+                .describedAs("Config directory");
+        optionparser.acceptsAll(Arrays.asList("paper", "paper-settings"), "File for Paper settings")
+                .withRequiredArg()
+                .ofType(File.class)
+                .defaultsTo(new File("paper.yml"))
+                .describedAs("Yml file");
+        optionparser.acceptsAll(Arrays.asList("add-plugin", "add-extra-plugin-jar"), "Specify paths to extra plugin jars to be loaded in addition to those in the plugins folder. This argument can be specified multiple times, once for each extra plugin jar path.")
+                .withRequiredArg()
+                .ofType(File.class)
+                .defaultsTo(new File[] {})
+                .describedAs("Jar file");
+        // Paper end
+
+        // Purpur Start
+        optionparser.acceptsAll(Arrays.asList("purpur", "purpur-settings"), "File for purpur settings")
+                .withRequiredArg()
+                .ofType(File.class)
+                .defaultsTo(new File("purpur.yml"))
+                .describedAs("Yml file");
+
+        optionparser.acceptsAll(Arrays.asList("pufferfish", "pufferfish-settings"), "File for pufferfish settings")
+                .withRequiredArg()
+                .ofType(File.class)
+                .defaultsTo(new File("pufferfish.yml"))
+                .describedAs("Yml file");
+        // Purpur end
+
+        // Paper start
+        optionparser.acceptsAll(Arrays.asList("server-name"), "Name of the server")
+                .withRequiredArg()
+                .ofType(String.class)
+                .defaultsTo("Unknown Server")
+                .describedAs("Name");
+        // Paper end
+
+        // Youer Start
+        optionparser.acceptsAll(Arrays.asList("Y", "youer-settings"), "File for youer settings")
+                .withRequiredArg()
+                .ofType(File.class)
+                .defaultsTo(new File("youer-config","youer.yml"))
+                .describedAs("Yml file");
+        // Youer End
 
         try {
             OptionSet optionset = optionparser.parse(p_129699_);
@@ -90,6 +_,30 @@
                 optionparser.printHelpOn(System.err);
                 return;
             }
+            Path path2 = Paths.get("eula.txt");
+            Eula eula = new Eula(path2);
+            // Paper start - load config files early for access below if needed
+            org.bukkit.configuration.file.YamlConfiguration bukkitConfiguration = io.papermc.paper.configuration.PaperConfigurations.loadLegacyConfigFile((File) optionset.valueOf("bukkit-settings"));
+            org.bukkit.configuration.file.YamlConfiguration spigotConfiguration = io.papermc.paper.configuration.PaperConfigurations.loadLegacyConfigFile((File) optionset.valueOf("spigot-settings"));
+            // Paper end - load config files early for access below if needed
+            if (!eula.hasAgreedToEULA()) {
+                LOGGER.info("You need to agree to the EULA in order to run the server. Go to eula.txt for more info.");
+                return;
+            }
+
+            if (optionset.has("nojline")) {
+                System.setProperty(net.minecrell.terminalconsole.TerminalConsoleAppender.JLINE_OVERRIDE_PROPERTY, "false");
+                org.bukkit.craftbukkit.Main.useJline = false;
+            }
+
+            if (optionset.has("noconsole")) {
+                org.bukkit.craftbukkit.Main.useConsole = false;
+                org.bukkit.craftbukkit.Main.useJline = false; // Paper
+                System.setProperty(net.minecrell.terminalconsole.TerminalConsoleAppender.JLINE_OVERRIDE_PROPERTY, "false"); // Paper
+            }
+
+            System.setProperty("library.jansi.version", "Youer"); // Paper - set meaningless jansi version to prevent git builds from crashing on Windows
+            org.spigotmc.SpigotConfig.disabledAdvancements = spigotConfiguration.getStringList("advancements.disabled"); // Paper - fix SPIGOT-5885, must be set early in init
 
             Path path = optionset.valueOf(optionspec14);
             if (path != null) {
@@ -101,28 +_,57 @@
                 JvmProfiler.INSTANCE.start(Environment.SERVER);
             }
 
+            io.papermc.paper.plugin.PluginInitializerManager.load(optionset); // Paper
             Bootstrap.bootStrap();
             Bootstrap.validate();
             Util.startTimerHackThread();
             Path path1 = Paths.get("server.properties");
+            if (!optionset.has(optionspec1)) net.neoforged.neoforge.server.loading.ServerModLoader.load(); // Load mods before we load almost anything else anymore. Single spot now. Only loads if they haven't passed the initserver param
             DedicatedServerSettings dedicatedserversettings = new DedicatedServerSettings(path1);
             dedicatedserversettings.forceSave();
             RegionFileVersion.configure(dedicatedserversettings.getProperties().regionFileComression);
-            Path path2 = Paths.get("eula.txt");
-            Eula eula = new Eula(path2);
             if (optionset.has(optionspec1)) {
+                // CraftBukkit start - SPIGOT-5761: Create bukkit.yml and commands.yml if not present
+                File configFile = (File) optionset.valueOf("bukkit-settings");
+                org.bukkit.configuration.file.YamlConfiguration configuration = org.bukkit.configuration.file.YamlConfiguration.loadConfiguration(configFile);
+                configuration.options().copyDefaults(true);
+                configuration.setDefaults(org.bukkit.configuration.file.YamlConfiguration.loadConfiguration(new java.io.InputStreamReader(Main.class.getClassLoader().getResourceAsStream("configurations/bukkit.yml"), com.google.common.base.Charsets.UTF_8)));
+                configuration.save(configFile);
+
+                File commandFile = (File) optionset.valueOf("commands-settings");
+                org.bukkit.configuration.file.YamlConfiguration commandsConfiguration = org.bukkit.configuration.file.YamlConfiguration.loadConfiguration(commandFile);
+                commandsConfiguration.options().copyDefaults(true);
+                commandsConfiguration.setDefaults(org.bukkit.configuration.file.YamlConfiguration.loadConfiguration( new java.io.InputStreamReader(Main.class.getClassLoader().getResourceAsStream("configurations/commands.yml"), com.google.common.base.Charsets.UTF_8)));
+                commandsConfiguration.save(commandFile);
+                // CraftBukkit end
                 LOGGER.info("Initialized '{}' and '{}'", path1.toAbsolutePath(), path2.toAbsolutePath());
                 return;
             }
 
-            if (!eula.hasAgreedToEULA()) {
-                LOGGER.info("You need to agree to the EULA in order to run the server. Go to eula.txt for more info.");
-                return;
+            File configYmenu = new File("youer-config/menu", "example.yml");
+            if (!configYmenu.exists()) {
+                org.bukkit.configuration.file.YamlConfiguration configurationYmenu = org.bukkit.configuration.file.YamlConfiguration.loadConfiguration(configYmenu);
+                configurationYmenu.options().copyDefaults(true);
+                configurationYmenu.setDefaults(org.bukkit.configuration.file.YamlConfiguration.loadConfiguration(new java.io.InputStreamReader(Main.class.getClassLoader().getResourceAsStream("youer-config/menu/example.yml"), com.google.common.base.Charsets.UTF_8)));
+                configurationYmenu.save(configYmenu);
             }
 
-            File file1 = new File(optionset.valueOf(optionspec9));
-            Services services = Services.create(new YggdrasilAuthenticationService(Proxy.NO_PROXY), file1);
+            // Paper start - fix SPIGOT-5824
+            File file1;
+            File userCacheFile = new File(Services.USERID_CACHE_FILE);
+            if (optionset.has(optionspec9)) {
+                file1 = new File(optionset.valueOf(optionspec9));
+                userCacheFile = new File(file1, Services.USERID_CACHE_FILE);
+            } else {
+                file1 = new File(bukkitConfiguration.getString("settings.world-container", "."));
+            }
+            // Paper end - fix SPIGOT-5824
+            Services services = Services.create(new com.destroystokyo.paper.profile.PaperAuthenticationService(Proxy.NO_PROXY), file1, userCacheFile, optionset); // Paper - pass OptionSet to load paper config files; override authentication service; fix world-container
             String s = Optional.ofNullable(optionset.valueOf(optionspec10)).orElse(dedicatedserversettings.getProperties().levelName);
+            if (s == null || s.isEmpty() || new File(file1, s).getAbsolutePath().equals(new File(s).getAbsolutePath())) {
+                LOGGER.error("Invalid world directory specified, must not be null, empty or the same directory as your universe! " + s);
+                return;
+            }
             LevelStorageSource levelstoragesource = LevelStorageSource.createDefault(file1.toPath());
             LevelStorageSource.LevelStorageAccess levelstoragesource$levelstorageaccess = levelstoragesource.validateAndCreateAccess(s);
             Dynamic<?> dynamic;
@@ -131,6 +_,7 @@
                 try {
                     dynamic = levelstoragesource$levelstorageaccess.getDataTag();
                     levelsummary = levelstoragesource$levelstorageaccess.getSummary(dynamic);
+                    levelstoragesource$levelstorageaccess.readAdditionalLevelSaveData(false);
                 } catch (NbtException | ReportedNbtException | IOException ioexception1) {
                     LevelStorageSource.LevelDirectory levelstoragesource$leveldirectory = levelstoragesource$levelstorageaccess.getLevelDirectory();
                     LOGGER.warn("Failed to load world data from {}", levelstoragesource$leveldirectory.dataFile(), ioexception1);
@@ -139,6 +_,7 @@
                     try {
                         dynamic = levelstoragesource$levelstorageaccess.getDataTagFallback();
                         levelsummary = levelstoragesource$levelstorageaccess.getSummary(dynamic);
+                        levelstoragesource$levelstorageaccess.readAdditionalLevelSaveData(true);
                     } catch (NbtException | ReportedNbtException | IOException ioexception) {
                         LOGGER.error("Failed to load world data from {}", levelstoragesource$leveldirectory.oldDataFile(), ioexception);
                         LOGGER.error(
@@ -173,6 +_,33 @@
 
             PackRepository packrepository = ServerPacksSource.createPackRepository(levelstoragesource$levelstorageaccess);
 
+            // CraftBukkit start
+            File bukkitDataPackFolder = new File(levelstoragesource$levelstorageaccess.getLevelPath(net.minecraft.world.level.storage.LevelResource.DATAPACK_DIR).toFile(), "bukkit");
+            if (!bukkitDataPackFolder.exists()) {
+                bukkitDataPackFolder.mkdirs();
+            }
+            File mcMeta = new File(bukkitDataPackFolder, "pack.mcmeta");
+            try {
+                com.google.common.io.Files.write("{\n"
+                        + "    \"pack\": {\n"
+                        + "        \"description\": \"Data pack for resources provided by Bukkit plugins\",\n"
+                        + "        \"pack_format\": " + SharedConstants.getCurrentVersion().getPackVersion(net.minecraft.server.packs.PackType.SERVER_DATA) + "\n"
+                        + "    }\n"
+                        + "}\n", mcMeta, com.google.common.base.Charsets.UTF_8);
+            } catch (java.io.IOException ex) {
+                throw new RuntimeException("Could not initialize Bukkit datapack", ex);
+            }
+            java.util.concurrent.atomic.AtomicReference<net.minecraft.server.WorldLoader.DataLoadContext> worldLoader = new java.util.concurrent.atomic.AtomicReference<>();
+            // CraftBukkit end
+
+            if (gametestEnabled) {
+                net.neoforged.neoforge.gametest.GameTestHooks.registerGametests();
+                net.minecraft.core.BlockPos spawnPos = optionset.valueOf(spawnPosOpt);
+                MinecraftServer.spin(thread -> net.minecraft.gametest.framework.GameTestServer.create(thread, levelstoragesource$levelstorageaccess, packrepository, net.minecraft.gametest.framework.GameTestRegistry.getAllTestFunctions(), spawnPos));
+                // If we're running a gametest server we don't need to load the resources normally (GameTestServer#create does it using a flat world)
+                // or create a shutdown thread as the gametest server will always exit itself
+                return;
+            }
             WorldStem worldstem;
             try {
                 WorldLoader.InitConfig worldloader$initconfig = loadOrCreateConfig(dedicatedserversettings.getProperties(), dynamic1, flag, packrepository);
@@ -180,6 +_,7 @@
                         p_248086_ -> WorldLoader.load(
                                 worldloader$initconfig,
                                 p_307161_ -> {
+                                    worldLoader.set(p_307161_);
                                     Registry<LevelStem> registry = p_307161_.datapackDimensions().registryOrThrow(Registries.LEVEL_STEM);
                                     if (dynamic1 != null) {
                                         LevelDataAndDimensions leveldataanddimensions = LevelStorageSource.getLevelDataAndDimensions(
@@ -214,6 +_,9 @@
                                             worlddimensions = dedicatedserverproperties.createDimensions(p_307161_.datapackWorldgen());
                                         }
 
+                                        // Neo: Do a write-read-cycle to inject modded dimensions on first start of a dedicated server into its generated world dimensions list.
+                                        var registryOps = net.minecraft.resources.RegistryOps.create(net.minecraft.nbt.NbtOps.INSTANCE, p_307161_.datapackWorldgen());
+                                        worlddimensions = WorldDimensions.CODEC.encoder().encodeStart(registryOps, worlddimensions).flatMap((writtenPayloadWithModdedDimensions) -> WorldDimensions.CODEC.decoder().parse(registryOps, writtenPayloadWithModdedDimensions)).resultOrPartial(LOGGER::error).orElse(worlddimensions);
                                         WorldDimensions.Complete worlddimensions$complete = worlddimensions.bake(registry);
                                         Lifecycle lifecycle = worlddimensions$complete.lifecycle().add(p_307161_.datapackWorldgen().allRegistriesLifecycle());
                                         return new WorldLoader.DataLoadOutput<>(
@@ -246,6 +_,7 @@
 
             WorldData worlddata = worldstem.worldData();
             levelstoragesource$levelstorageaccess.saveDataTag(registryaccess$frozen, worlddata);
+            Class.forName(net.minecraft.world.entity.npc.VillagerTrades.class.getName()); // Paper - load this sync so it won't fail later async
             final DedicatedServer dedicatedserver = MinecraftServer.spin(
                 p_293760_ -> {
                     DedicatedServer dedicatedserver1 = new DedicatedServer(
@@ -258,12 +_,13 @@
                         services,
                         LoggerChunkProgressListener::createFromGameruleRadius
                     );
+                    dedicatedserver1.worldLoader(worldLoader.get(), optionset);
                     dedicatedserver1.setPort(optionset.valueOf(optionspec11));
                     dedicatedserver1.setDemo(optionset.has(optionspec2));
                     dedicatedserver1.setId(optionset.valueOf(optionspec12));
                     boolean flag2 = !optionset.has(optionspec) && !optionset.valuesOf(optionspec15).contains("nogui");
                     if (flag2 && !GraphicsEnvironment.isHeadless()) {
-                        dedicatedserver1.showGui();
+                        // dedicatedserver1.showGui();
                     }
 
                     return dedicatedserver1;
@@ -273,6 +_,7 @@
                 @Override
                 public void run() {
                     dedicatedserver.halt(true);
+                    org.apache.logging.log4j.LogManager.shutdown(); // we're manually managing the logging shutdown on the server. Make sure we do it here at the end.
                 }
             };
             thread.setUncaughtExceptionHandler(new DefaultUncaughtExceptionHandler(LOGGER));
