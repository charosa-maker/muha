--- a/net/minecraft/world/inventory/BeaconMenu.java
+++ b/net/minecraft/world/inventory/BeaconMenu.java
@@ -8,10 +_,13 @@
 import net.minecraft.world.Container;
 import net.minecraft.world.SimpleContainer;
 import net.minecraft.world.effect.MobEffect;
+import net.minecraft.world.entity.player.Inventory;
 import net.minecraft.world.entity.player.Player;
 import net.minecraft.world.item.ItemStack;
 import net.minecraft.world.level.Level;
 import net.minecraft.world.level.block.Blocks;
+import org.bukkit.craftbukkit.inventory.CraftInventoryBeacon;
+import org.bukkit.craftbukkit.inventory.view.CraftBeaconView;
 
 public class BeaconMenu extends AbstractContainerMenu {
     private static final int PAYMENT_SLOT = 0;
@@ -32,10 +_,31 @@
         public int getMaxStackSize() {
             return 1;
         }
+        // Paper start - Fix inventories returning null Locations
+        @Override
+        public org.bukkit.Location getLocation() {
+            return access.getLocation();
+        }
+        // Paper end - Fix inventories returning null Locations
+
     };
     private final BeaconMenu.PaymentSlot paymentSlot;
     private final ContainerLevelAccess access;
     private final ContainerData beaconData;
+    // CraftBukkit start
+    private CraftBeaconView bukkitEntity = null;
+    private Inventory player;
+    @Override
+    public CraftBeaconView getBukkitView() {
+        if (bukkitEntity != null) {
+            return bukkitEntity;
+        }
+
+        CraftInventoryBeacon inventory = new CraftInventoryBeacon(this.beacon);
+        bukkitEntity = new CraftBeaconView(this.player.player.getBukkitEntity(), inventory, this);
+        return bukkitEntity;
+    }
+    // CraftBukkit end
 
     public BeaconMenu(int p_39036_, Container p_39037_) {
         this(p_39036_, p_39037_, new SimpleContainerData(3), ContainerLevelAccess.NULL);
@@ -44,6 +_,7 @@
     public BeaconMenu(int p_39039_, Container p_39040_, ContainerData p_39041_, ContainerLevelAccess p_39042_) {
         super(MenuType.BEACON, p_39039_);
         checkContainerDataCount(p_39041_, 3);
+        this.player = (Inventory) p_39040_; // CraftBukkit - TODO: check this
         this.beaconData = p_39041_;
         this.access = p_39042_;
         this.paymentSlot = new BeaconMenu.PaymentSlot(this.beacon, 0, 136, 110);
@@ -76,6 +_,7 @@
 
     @Override
     public boolean stillValid(Player p_39047_) {
+        if (!this.checkReachable) return true; // CraftBukkit
         return stillValid(this.access, p_39047_, Blocks.BEACON);
     }
 
@@ -98,10 +_,8 @@
                 }
 
                 slot.onQuickCraft(itemstack1, itemstack);
-            } else if (!this.paymentSlot.hasItem() && this.paymentSlot.mayPlace(itemstack1) && itemstack1.getCount() == 1) {
-                if (!this.moveItemStackTo(itemstack1, 0, 1, false)) {
-                    return ItemStack.EMPTY;
-                }
+            } else if (this.moveItemStackTo(itemstack1, 0, 1, false)) { //Forge Fix Shift Clicking in beacons with stacks larger then 1.
+                return ItemStack.EMPTY;
             } else if (p_39052_ >= 1 && p_39052_ < 28) {
                 if (!this.moveItemStackTo(itemstack1, 28, 37, false)) {
                     return ItemStack.EMPTY;
@@ -153,12 +_,30 @@
         return decodeEffect(this.beaconData.get(2));
     }
 
+    // Paper start - Add PlayerChangeBeaconEffectEvent
+    private static @Nullable org.bukkit.potion.PotionEffectType convert(Optional<Holder<MobEffect>> optionalEffect) {
+        return optionalEffect.map(org.bukkit.craftbukkit.potion.CraftPotionEffectType::minecraftHolderToBukkit).orElse(null);
+    }
+    // Paper end - Add PlayerChangeBeaconEffectEvent
+
     public void updateEffects(Optional<Holder<MobEffect>> p_219973_, Optional<Holder<MobEffect>> p_219974_) {
+        // Paper start - fix MC-174630 - validate secondary power
+        if (p_219974_.isPresent() && p_219974_.get() != net.minecraft.world.effect.MobEffects.REGENERATION && (p_219973_.isPresent() && p_219974_.get() != p_219973_.get())) {
+            p_219974_ = Optional.empty();
+        }
+        // Paper end
         if (this.paymentSlot.hasItem()) {
-            this.beaconData.set(1, encodeEffect(p_219973_.orElse(null)));
-            this.beaconData.set(2, encodeEffect(p_219974_.orElse(null)));
-            this.paymentSlot.remove(1);
-            this.access.execute(Level::blockEntityChanged);
+            // Paper start - Add PlayerChangeBeaconEffectEvent
+            io.papermc.paper.event.player.PlayerChangeBeaconEffectEvent event = new io.papermc.paper.event.player.PlayerChangeBeaconEffectEvent((org.bukkit.entity.Player) this.player.player.getBukkitEntity(), convert(p_219973_), convert(p_219974_), this.access.getLocation().getBlock());
+            if (event.callEvent()) {
+                // Paper end - Add PlayerChangeBeaconEffectEvent
+                this.beaconData.set(1, BeaconMenu.encodeEffect(event.getPrimary() == null ? null : org.bukkit.craftbukkit.potion.CraftPotionEffectType.bukkitToMinecraftHolder(event.getPrimary())));// CraftBukkit - decompile error
+                this.beaconData.set(2, BeaconMenu.encodeEffect(event.getSecondary() == null ? null : org.bukkit.craftbukkit.potion.CraftPotionEffectType.bukkitToMinecraftHolder(event.getSecondary())));// CraftBukkit - decompile error
+                if (event.willConsumeItem()) { // Paper
+                    this.paymentSlot.remove(1);
+                } // Paper
+                this.access.execute(Level::blockEntityChanged);
+            } // Paper end - Add PlayerChangeBeaconEffectEvent
         }
     }
 
